<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard do Aluno | RegiMath</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="/css/dashboard_aluno.css">
  <link rel="icon" href="/imagens/Regimath_sem fundo cor preto2.png"/>
</head>

<body>
  <header>
    <a href="/">
      <img src="/imagens/RM_bordo.png" alt="Regimath Logo" class="logo">
    </a>
    <button id="menu-btn" class="menu-btn" aria-label="Abrir menu principal">☰</button>
  </header>

  <section id="overlay"></section>

  <nav id="menu" class="overlay collapsed">

    <button id="close-menu" aria-label="Fechar menu">&times;</button>

    <button id="toggle-menu" aria-label="Recolher menu">
      <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg>
    </button>

    <ul class="nav-links">
      <li><a href="/"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#fff"><path d="M264-216h96v-240h240v240h96v-348L480-726 264-564v348Zm-72 72v-456l288-216 288 216v456H528v-240h-96v240H192Zm288-327Z"/></svg>Home</a></li>

      <% if (session.user_aluno) { %>
          <li><a href="/perfil_aluno"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>Perfil aluno</a></li>
          <li><a href="/dashboard_aluno" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h240v-560H200v560Zm320 0h240v-280H520v280Zm0-360h240v-200H520v200Z"/></svg>Dashboard Aluno</a></li>
          <li><a href="/agenda" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#fff"><path d="M216-96q-29.7 0-50.85-21.5Q144-139 144-168v-528q0-29 21.15-50.5T216-768h72v-96h72v96h240v-96h72v96h72q29.7 0 50.85 21.5Q816-725 816-696v528q0 29-21.15 50.5T744-96H216Zm0-72h528v-360H216v360Zm0-432h528v-96H216v96Zm0 0v-96 96Zm264.21 216q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Zm-156 0q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Zm312 0q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Zm-156 144q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Zm-156 0q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Zm312 0q-15.21 0-25.71-10.29t-10.5-25.5q0-15.21 10.29-25.71t25.5-10.5q15.21 0 25.71 10.29t10.5 25.5q0 15.21-10.29 25.71t-25.5 10.5Z"/></svg>Agenda</a></li>
          <li><a href="/historico_chats" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>Histórico de Chats</a></li>
          <li><a href="/logout"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#fff"><path d="M216-144q-29.7 0-50.85-21.15Q144-186.3 144-216v-528q0-29.7 21.15-50.85Q186.3-816 216-816h264v72H216v528h264v72H216Zm432-168-51-51 81-81H384v-72h294l-81-81 51-51 168 168-168 168Z"/></svg>Sair</a></li>
      <% } %>
    </ul>
  </nav>

  <main class="dashboard">
    <section class="welcome">
      <section>
        <h1>Olá, <p class="highlight"><%= user.nome || "Aluno" %></p></h1>
        <p>Bem-vindo ao seu painel! Aqui você pode acompanhar suas aulas, professores e progresso.</p>
      </section>
    </section>

    <% 
        const now = new Date();
        const next24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);

        const aulasProximas24h = (user.agenda || []).filter(aula => {
            const aulaDate = new Date(aula.data + 'T' + aula.hora);
            return aulaDate >= now && aulaDate <= next24Hours;
        });
        const count = aulasProximas24h.length;

        const comentarios = session.prof_comentarios || {};
        let totalAvaliacoes = 0;
        let numeroDeAvaliacoes = 0;
        Object.values(comentarios).forEach(profComentarios => {
            profComentarios.forEach(comentario => {
                if (comentario.usuario === user.nome && comentario.nota) {
                    totalAvaliacoes += comentario.nota;
                    numeroDeAvaliacoes++;
                }
            });
        });
        const mediaAvaliacoes = numeroDeAvaliacoes > 0 ? (totalAvaliacoes / numeroDeAvaliacoes).toFixed(1) : "N/A";
    %>

    <section class="stats">
        <section class="card">
            <i class="fas fa-calendar-check icon primary"></i>
            <h3>Próximas 24h</h3>
            <p class="value"><%= count %> aula<%= count !== 1 ? 's' : '' %> agendada<%= count !== 1 ? 's' : '' %></p>
            <a href="/agenda" class="link">Ver agenda <i class="fas fa-arrow-right"></i></a>
        </section>

        <section class="card">
            <i class="fa-solid fa-star icon warning"></i>
            <h3>Minhas Avaliações</h3>
            <p class="value"><%= mediaAvaliacoes %> / 5.0</p>
            <a href="/feedbacks_aluno" class="link">Ver feedbacks <i class="fas fa-arrow-right"></i></a>
        </section>
    </section>
    
    <section class="notifications card">
      <h2><i class="fas fa-bell"></i> Notificações Recentes</h2>
      <% const notificacoes = user.notificacoes || []; %>
      <% if (notificacoes.length > 0) { %>
          <ul class="notification-list">
              <% notificacoes.slice(0, 5).forEach(notif => { %>
                  <li class="notification-item <%= notif.tipo %>">
                      <section class="notification-header">
                          <strong class="prof-nome"><%= notif.professor %></strong>
                          <p>cancelou a aula de <%= notif.aula.data %> às <%= notif.aula.hora %>.</p>
                      </section>
                      <% if (notif.motivo) { %>
                          <p class="motivo"><strong>Motivo:</strong> <%= notif.motivo %></p>
                      <% } %>
                      <small class="timestamp"><%= new Date(notif.data).toLocaleString('pt-BR') %></small>
                  </li>
              <% }); %>
          </ul>
      <% } else { %>
          <p class="empty-state">Nenhuma notificação recente.</p>
      <% } %>
    </section>

    <% 
        const sortedAgenda = (user.agenda || []).map(aula => ({...aula, fullDate: new Date(aula.data + 'T' + aula.hora)})).sort((a, b) => a.fullDate - b.fullDate);
        const proximaAula = sortedAgenda.find(aula => aula.fullDate >= now);
    %>

    <% if (proximaAula) { %>
    <section class="next-class">
        <section class="class-info">
            <h2><i class="fas fa-clock"></i> Próxima Aula</h2>
            <p><strong><%= proximaAula.hora %> - <%= proximaAula.materia || 'Matéria não definida' %></strong></p>
            <p><i class="fas fa-user"></i> Professor: <%= proximaAula.professor.nome %></p>
            <p><i class="fas fa-calendar-day"></i> <%= new Date(proximaAula.data + 'T00:00:00').toLocaleDateString('pt-BR') %></p>
        </section>
        <section class="class-actions">
            <a href="/video/<%= proximaAula.salaId %>" class="btn primary"><i class="fas fa-video"></i> Entrar na Aula</a>
            <a href="/chat/with/<%= proximaAula.professor.id %>" class="btn secondary"><i class="fas fa-comment-dots"></i> Enviar Mensagem</a>
        </section>
    </section>
    <% } else { %>
        <section class="next-class">
            <section class="class-info">
                 <h2><i class="fas fa-clock"></i> Próxima Aula</h2>
                <p>Nenhuma aula agendada.</p>
            </section>
        </section>
    <% } %>


    <section class="manage">
      <h2><i class="fas fa-cogs"></i> Acesso Rápido</h2>
      <section class="manage-grid">
        <a href="/pesquisar_profs" class="manage-item">
          <i class="fas fa-search"></i>
          <p>Encontrar Professores</p>
        </a>
        <a href="/agenda" class="manage-item">
          <i class="fas fa-history"></i>
          <p>Histórico de Aulas</p>
        </a>
      </section>
    </section>
  </main>

  <script>
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('close-menu');
    const toggleBtn = document.getElementById("toggle-menu");

    function toggleMobileMenu() {
      menu.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.classList.toggle('no-scroll', menu.classList.contains('active'));
    }

    if (menuBtn) menuBtn.addEventListener('click', toggleMobileMenu);
    if (overlay) overlay.addEventListener('click', toggleMobileMenu);
    if (closeBtn) closeBtn.addEventListener('click', toggleMobileMenu);

    if (toggleBtn) {
      const toggleIcon = document.getElementById('toggle-icon');
      const isCollapsed = menu.classList.contains('collapsed');
      toggleBtn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
      if (isCollapsed) toggleIcon.style.transform = 'rotate(180deg)';

      toggleBtn.addEventListener("click", (e) => {
        e.preventDefault();
        menu.classList.toggle("collapsed");
        const isNowCollapsed = menu.classList.contains('collapsed');
        toggleBtn.setAttribute('aria-expanded', isNowCollapsed ? 'false' : 'true');
        toggleIcon.style.transform = isNowCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      });
    }
  </script>
</body>
</html>
