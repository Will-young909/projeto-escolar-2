<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Regimath</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="../css/cadastro.css">
    <link rel="icon" href="../imagens/Regimath_sem fundo cor preto2.png"/>
    <style>
        /* ====== Estilos de feedback visual (mantidos no EJS para rápida referência, mas idealmente no CSS) ====== */
        .invalid {
            border-color: #c0392b !important;
            box-shadow: 0 0 4px rgba(192, 57, 43, 0.5) !important;
        }
        .valid {
            border-color: #27ae60 !important;
            box-shadow: 0 0 4px rgba(39, 174, 96, 0.5) !important;
        }
        .error-feedback {
            color: #c0392b;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        /* NOVO: Estilo para sumário de erros do servidor (melhorado no CSS abaixo) */
        .error-summary {
            border: 1px solid #c0392b;
            background: #fdecea;
            color: #b71c1c;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .error-summary h4 { margin: 0 0 8px; }
        .error-summary ul { padding-left: 20px; margin-top: 5px; }
    </style>
</head>
<body>
    <header>
        <a href="/">
            <img src="/imagens/RM_bordo.png" alt="Regimath Logo" class="logo">
        </a>
    </header>
    <main>

    <form id="cadastroForm" action="/cadastro" method="POST" novalidate>
        <h2>Crie sua conta Regimath</h2>
            
        <section class="form-group">
            <label for="email"><i class="fas fa-envelope"></i> Email </label>
            <input type="email" id="email" name="email" required 
                   value="<%= dados?.email || '' %>" 
                   class="<%= erros?.email ? 'invalid' : '' %>"
                   aria-invalid="<%= erros?.email ? 'true' : 'false' %>"
                   aria-describedby="err-email">
            <p id="err-email" class="error-feedback" aria-live="polite"><%= erros?.email?.msg || '' %></p>
        </section>

        <section class="form-group">
            <label for="nome"><i class="fas fa-user"></i> Nome </label>
            <input type="text" id="nome" name="nome" required 
                   value="<%= dados?.nome || '' %>" 
                   class="<%= erros?.nome ? 'invalid' : '' %>"
                   aria-invalid="<%= erros?.nome ? 'true' : 'false' %>"
                   aria-describedby="err-nome">
            <p id="err-nome" class="error-feedback" aria-live="polite"><%= erros?.nome?.msg || '' %></p>
        </section>

        <section class="form-group">
            <label for="senha">
                <i class="fas fa-lock"></i> Senha <p class="info-tooltip" title="Mínimo 6 caracteres. Recomendamos letras, números e símbolos."></p>
            </label>
            <input type="password" id="senha" name="senha" minlength="6" required 
                   class="<%= erros?.senha ? 'invalid' : '' %>"
                   aria-invalid="<%= erros?.senha ? 'true' : 'false' %>"
                   aria-describedby="err-senha">
            <p id="err-senha" class="error-feedback" aria-live="polite"><%= erros?.senha?.msg || '' %></p>
        </section>

        <section class="form-group">
            <label for="confirmar"><i class="fas fa-lock"></i> Confirmar Senha </label>
            <input type="password" id="confirmar" name="confirmar" required 
                   class="<%= erros?.confirmar ? 'invalid' : '' %>"
                   aria-invalid="<%= erros?.confirmar ? 'true' : 'false' %>"
                   aria-describedby="err-confirmar">
            <p id="err-confirmar" class="error-feedback" aria-live="polite"><%= erros?.confirmar?.msg || '' %></p>
        </section>

        <section class="form-group">
            <label for="tipo"><i class="fas fa-graduation-cap"></i> Eu sou: </label>
            <select id="tipo" name="tipo" required 
                    class="<%= erros?.tipo ? 'invalid' : '' %>"
                    aria-invalid="<%= erros?.tipo ? 'true' : 'false' %>"
                    aria-describedby="err-tipo">
                <option value="" disabled <%= !dados?.tipo ? 'selected' : '' %>>Selecione se é Aluno ou Professor</option>
                <option value="aluno" <%= dados?.tipo === 'aluno' ? 'selected' : '' %>>Aluno</option>
                <option value="professor" <%= dados?.tipo === 'professor' ? 'selected' : '' %>>Professor</option>
            </select>
            <p id="err-tipo" class="error-feedback" aria-live="polite"><%= erros?.tipo?.msg || '' %></p>
        </section>

        <button type="submit" class="btn-primary" id="btn-submit">
            <i class="fas fa-user-plus"></i> Criar Conta
        </button>

        <section class="links-footer">
            <p>Já tem uma conta? <a href="/login" class="link-secundario">Faça login</a></p>
            <p><a href="/" class="link-secundario">Voltar para a página inicial</a></p>
        </section>
    </form>
    </main>
    <script>
    (function() {
        const form = document.getElementById('cadastroForm');
        const submitButton = document.getElementById('btn-submit');
        const campos = {
            email: document.getElementById('email'),
            nome: document.getElementById('nome'),
            senha: document.getElementById('senha'),
            confirmar: document.getElementById('confirmar'),
            tipo: document.getElementById('tipo')
        };
        const errorFeedbackIds = ['err-email','err-nome','err-senha','err-confirmar','err-tipo'];

        // Função de validação única para reuso
        function validateField(input) {
            let errorMsg = '';
            let isValid = true;

            // Validação de required básica (para todos)
            if (input.hasAttribute('required') && !input.value.trim()) {
                errorMsg = 'Este campo é obrigatório.';
                isValid = false;
            } else if (input.id === 'email') {
                if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(input.value.trim())) {
                    errorMsg = 'Por favor, insira um email válido.';
                    isValid = false;
                }
            } else if (input.id === 'senha') {
                if (input.value.length > 0 && input.value.length < 6) {
                    errorMsg = 'A senha deve ter pelo menos 6 caracteres.';
                    isValid = false;
                }
            } else if (input.id === 'confirmar') {
                const senha = campos.senha.value;
                if (input.value !== senha) {
                    errorMsg = 'As senhas não coincidem.';
                    isValid = false;
                }
            } else if (input.id === 'tipo' && !input.value) {
                errorMsg = 'Selecione um tipo (Aluno ou Professor).';
                isValid = false;
            }
            
            return { isValid, errorMsg };
        }

        // 1. Lógica do Submit (Pré-envio)
        form.addEventListener('submit', function(e) {
            let hasErrors = false;

            // Limpa estilos de validação anteriores (mantém os erros do servidor via EJS)
            Object.values(campos).forEach(el => el && el.classList.remove('invalid', 'valid'));
            errorFeedbackIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '';
            });

            // Revalida todos os campos
            Object.keys(campos).forEach(key => {
                const input = campos[key];
                if (!input) return;

                const { isValid, errorMsg } = validateField(input);

                if (!isValid) {
                    hasErrors = true;
                    input.classList.add('invalid');
                    input.setAttribute('aria-invalid', 'true');
                    const errorEl = document.getElementById('err-' + key);
                    if (errorEl) errorEl.textContent = errorMsg;
                } else {
                    input.classList.add('valid');
                    input.setAttribute('aria-invalid', 'false');
                }
            });

            if (hasErrors) {
                e.preventDefault();
                // Rola e foca o primeiro campo inválido
                const firstInvalid = form.querySelector('.invalid');
                if (firstInvalid) {
                    try { firstInvalid.focus(); } catch(_) {}
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // Bloqueia múltiplos envios e dá feedback visual
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        });

        // 2. Feedback visual dinâmico (Input/Change)
        Object.values(campos).forEach(input => {
            if (!input) return;
            
            const handleValidation = () => {
                const { isValid, errorMsg } = validateField(input);
                const feedbackEl = document.getElementById('err-' + input.id);
                
                // Limpa classes
                input.classList.remove('invalid', 'valid');
                
                // Só aplica o feedback visual e de texto se o campo tiver valor
                if (input.value.trim() !== '' || input.id === 'tipo') {
                    if (isValid) {
                        input.classList.add('valid');
                        if (feedbackEl) feedbackEl.textContent = '';
                    } else {
                        input.classList.add('invalid');
                        if (feedbackEl) feedbackEl.textContent = errorMsg;
                    }
                } else {
                    // Limpa mensagens quando o campo obrigatório está vazio (exceto no submit)
                    if (feedbackEl) feedbackEl.textContent = ''; 
                }
            };

            input.addEventListener('input', handleValidation);
            input.addEventListener('change', handleValidation); // Para o select

            // Caso o campo de confirmar senha mude, revalida a senha também
            if (input.id === 'confirmar') {
                input.addEventListener('input', () => validateField(campos.senha));
            }
        });
    })();
    </script>
</body>
</html>