<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat com <%= interlocutorName %> | Regimath</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/chat.css">
    <link rel="icon" href="/imagens/Regimath_sem fundo cor preto2.png"/>
</head>

<body>
    <header class="chat-header">
        <section class="chat-header-content">
            <a onclick="history.back()" class="btn-back" aria-label="Voltar">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h3>Conversa com <%= interlocutorName %></h3>
        </section>
        <a href="/video/<%= room %>" class="btn-video" aria-label="Acessar Sala de Vídeo">
            <i class="fas fa-video"></i>
        </a>
    </header>

    <% if (user && user.tipo === 'professor') { %>
        <section class="payment-request-ui">
            <label for="payDescricao" class="ui-label">Criar Cobrança:</label>
            <input id="payDescricao" placeholder="Descrição (ex: Aula 1h)" class="ui-input desc-input" maxlength="50" />
            <input id="payValor" placeholder="Valor (ex: 50,00)" class="ui-input value-input" type="text" inputmode="decimal" />
            <button id="sendPaymentReq" class="btn-billing btn-primary" disabled>Cobrar</button>
        </section>
    <% } %>

    <main class="chat-main" id="chatBody"></main>

    <form id="chatForm" class="chat-form">
        <input id="chatMessage" type="text" placeholder="Digite sua mensagem..." autocomplete="off" required>
        <button type="submit" aria-label="Enviar mensagem">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>

    <script>
        const CHAT_USER_DATA = JSON.parse('<%- JSON.stringify(user || {}) %>');
        const CHAT_USER = {
            id: CHAT_USER_DATA.id,
            nome: CHAT_USER_DATA.nome || 'Visitante',
        };
        const CHAT_ROOM = "<%= room %>";
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        (function () {
            const socket = io();
            const chatBody = document.getElementById('chatBody');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatMessage');
            
            const sendPaymentBtn = document.getElementById('sendPaymentReq');
            const payDescInput = document.getElementById('payDescricao');
            const payValorInput = document.getElementById('payValor');

            const scrollToBottom = () => {
                chatBody.scrollTop = chatBody.scrollHeight;
            };

            const formatCurrencyInput = (input) => {
                let value = input.value.replace(/\D/g, '');
                if (value.length > 2) {
                    value = value.replace(/(\d{2})$/, ',$1');
                    if (value.length > 6) {
                        value = value.replace(/(\d+)(\d{3},\d{2})$/, '$1.$2');
                    }
                } else if (value.length === 1) {
                    value = '0,0' + value;
                } else if (value.length === 2) {
                    value = '0,' + value;
                }
                input.value = value;
            };

            const checkPaymentInputs = () => {
                if (!sendPaymentBtn) return;
                const desc = payDescInput.value.trim();
                const valor = payValorInput.value.replace(',', '.').replace(/[^\d.]/g, '');
                if (desc && parseFloat(valor) > 0) {
                    sendPaymentBtn.removeAttribute('disabled');
                } else {
                    sendPaymentBtn.setAttribute('disabled', 'disabled');
                }
            };

            if (payDescInput && payValorInput) {
                payDescInput.addEventListener('input', checkPaymentInputs);
                payValorInput.addEventListener('input', () => {
                    formatCurrencyInput(payValorInput);
                    checkPaymentInputs();
                });
            }

            function createMsg(msg) {
                const isSent = msg.user.id === CHAT_USER.id;
                const section = document.createElement('section');
                section.classList.add('message', isSent ? 'sent' : 'received');

                if (!isSent) {
                    const user = document.createElement('p');
                    user.classList.add('msg-user');
                    user.textContent = msg.user.nome;
                    section.appendChild(user);
                }

                const text = document.createElement('p');
                text.classList.add('msg-text');
                text.textContent = msg.text;

                const time = document.createElement('p');
                time.classList.add('msg-time');
                time.textContent = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                section.appendChild(text);
                section.appendChild(time);
                return section;
            }

            function createPaymentCard(data) {
                const wrap = document.createElement('section');
                const isSent = data.remetenteId === CHAT_USER.id;
                const valorFormatado = Number(data.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                wrap.className = `message payment-card ${isSent ? 'sent' : 'received'}`;
                
                wrap.innerHTML = `
                    <section class="payment-header">
                        <i class="fas fa-handshake payment-icon"></i>
                        <strong class="payment-title">Solicitação de Pagamento</strong>
                        <p class="payment-user">${isSent ? 'Você enviou:' : data.remetente + ' enviou:'}</p>
                    </section>
                    <section class="payment-details">
                        <section class="payment-desc">${data.descricao || 'Pagamento de Serviço'}</section>
                        <section class="payment-value">${valorFormatado}</section>
                    </section>
                    ${!isSent ? `
                        <a href="${data.link || '#'}" target="_blank" rel="noopener noreferrer" class="btn-pagar btn-success">
                            <i class="fas fa-wallet"></i> Pagar Agora
                        </a>
                        <small class="payment-note">Checkout seguro do Mercado Pago.</small>
                    ` : '<small class="payment-note sent-note">Link de pagamento criado.</small>'}
                `;
                return wrap;
            }

            socket.on("roomHistory", (history) => {
                chatBody.innerHTML = "";
                history.forEach(m => {
                    if (m.type === 'payment') {
                        chatBody.appendChild(createPaymentCard(m.data));
                    } else {
                        chatBody.appendChild(createMsg(m));
                    }
                });
                scrollToBottom();
            });

            socket.on("newMessage", (msg) => {
                chatBody.appendChild(createMsg(msg));
                scrollToBottom();
            });

            socket.on("systemMessage", (msg) => {
                const sys = document.createElement("section");
                sys.classList.add("system-msg");
                sys.textContent = msg.text;
                chatBody.appendChild(sys);
                scrollToBottom();
            });

            socket.emit("joinRoom", { room: CHAT_ROOM });

            chatForm.addEventListener("submit", e => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (!text) return;
                socket.emit("chatMessage", { room: CHAT_ROOM, text: text });
                chatInput.value = "";
            });

            socket.on('paymentRequest', (data) => {
                data.remetente = data.remetente || 'Professor'; 
                chatBody.appendChild(createPaymentCard(data));
                scrollToBottom();
            });

            socket.on('paymentConfirmed', (info) => {
                const section = document.createElement('section');
                section.className = 'system-msg success-msg'; 
                const amt = Number(info.amount || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                section.innerHTML = `✅ **Pagamento de ${amt} confirmado!** (${info.payer || 'Pagador desconhecido'})`;
                chatBody.appendChild(section);
                scrollToBottom();
            });

            if (sendPaymentBtn) {
                sendPaymentBtn.addEventListener('click', () => {
                    const desc = payDescInput.value.trim() || 'Aula';
                    const valor = parseFloat(payValorInput.value.replace('.', '').replace(',', '.')) || 0;
                    
                    if (!valor || valor <= 0) {
                        alert('Informe um valor válido.');
                        payValorInput.focus();
                        return;
                    }
                    
                    socket.emit('requestPayment', {
                        room: CHAT_ROOM,
                        valor: valor.toFixed(2),
                        descricao: desc,
                        createdBy: CHAT_USER.nome,
                        remetenteId: CHAT_USER.id
                    });

                    payDescInput.value = '';
                    payValorInput.value = '';
                    checkPaymentInputs(); 
                });
            }
        })();
    </script>
</body>
</html>
