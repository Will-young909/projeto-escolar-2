<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Histórico de Conversas | Regimath</title>

    <!-- FONTES + ICONES -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/historico.css">
    <link rel="icon" href="/imagens/Regimath_sem fundo cor preto2.png" />
</head>

<body>

    <header>
    <a href="/">
      <img src="/imagens/RM_bordo.png" alt="Regimath Logo" class="logo">
    </a>
    <button id="menu-btn" class="menu-btn" aria-label="Abrir menu principal">☰</button>
  </header>

  <section id="overlay"></section>

  <nav id="menu" class="overlay collapsed">

    <button id="close-menu" aria-label="Fechar menu">&times;</button>

    <button id="toggle-menu" aria-label="Recolher menu">
      <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="white">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg>
    </button>

    <ul class="nav-links">
        <li><a href="/"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#fff"><path d="M264-216h96v-240h240v240h96v-348L480-726 264-564v348Zm-72 72v-456l288-216 288 216v456H528v-240h-96v240H192Zm288-327Z"/></svg>Home</a></li>

      <% if (session.user_prof) { %>
        <li><a href="/perfil_prof"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>Perfil professor</a></li>
      <% }else if (session.user_aluno) { %>
           <li><a href="/perfil_aluno"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>Perfil aluno</a></li>
          <% } else { %>
            <li>
              <a href="/login"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M480-120v-80h280v-560H480v-80h280q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H480Zm-80-160-55-58 102-102H120v-80h327L345-622l55-58 200 200-200 200Z"/></svg>Login</a>
              <a href="/cadastro"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M720-400v-120H600v-80h120v-120h80v120h120v80H800v120h-80Zm-360-80q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm80-80h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0-80Zm0 400Z"/></svg>Cadastro</a>
            </li>
          <% } %>

        <% if (session.user_aluno) { %>
            <li><a href="/dashboard_aluno" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h240v-560H200v560Zm320 0h240v-280H520v280Zm0-360h240v-200H520v200Z"/></svg>Dashboard Aluno</a></li>
            <li><a href="/agenda" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h240v-560H200v560Zm320 0h240v-280H520v280Zm0-360h240v-200H520v200Z"/></svg>Agenda</a></li>
        <% } else if (session.user_prof) { %>
            <li><a href="/dashboard_prof" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h240v-560H200v560Zm320 0h240v-280H520v280Zm0-360h240v-200H520v200Z"/></svg>Dashboard Professor</a></li>
            <li><a href="/aulas" class="pa"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h240v-560H200v560Zm320 0h240v-280H520v280Zm0-360h240v-200H520v200Z"/></svg>Aulas</a></li>
        <% } %>

        <% if (session.user_aluno || session.user_prof) { %>
            <li><a href="/logout">Sair</a></li>
        <% } %>
    </ul>
  </nav>

    <main class="container">

        <h1 class="title">Histórico de Conversas</h1>

        <section class="search-bar">
        <form action="" method="GET" role="search">
            <section class="input-wrapper">
                <input type="search" placeholder="Pesquisar por pessoa" id="pesquisarPessoa" name="search" aria-label="Pesquisar pessoa" value="<%= locals.searchQuery || '' %>">
                <button type="submit" aria-label="Buscar" class="new"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
            </section>
        </form>
        </section>

        <% function formatLastActive(ts) {
            if (!ts) return "";
            const d = new Date(ts);
            const now = new Date();

            const today = now.toLocaleDateString('pt-BR');
            const date = d.toLocaleDateString('pt-BR');
            const time = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            if (date === today) return time;
            return date;
        } %>

        <% if (chats && chats.length > 0) { %>

            <section class="chat-list">
                <% chats.forEach(chat => { %>
                    
                    <a href="/chat/<%= chat.id %>" class="chat-card">

                        <section class="profile-wrapper">
                            <i class="fas fa-user-circle profile"></i>
                            <p class="status <%= chat.online ? 'online' : 'offline' %>"></p>
                        </section>

                        <section class="content">
                            <section class="top-row">
                                <h2 class="name"><%= chat.partnerName || "Conversa" %></h2>
                                <p class="time"><%= formatLastActive(chat.lastActive) %></p>
                            </section>

                            <p class="last-msg">
                                <%= chat.lastMessage ? chat.lastMessage.slice(0, 70) : "Nenhuma mensagem ainda." %>
                                <%= chat.lastMessage && chat.lastMessage.length > 70 ? "..." : "" %>
                            </p>

                            <% if (chat.partnerRole) { %>
                                <p class="tag <%= chat.partnerRole %>">
                                    <%= chat.partnerRole === 'professor' ? 'Professor' : 'Aluno' %>
                                </p>
                            <% } %>
                        </section>

                    </a>

                <% }) %>
            </section>

        <% } else { %>

            <section class="empty">
                <i class="fas fa-comments-slash icon"></i>
                <p>Nenhuma conversa iniciada.</p>
                <a href="/" class="btn-primary">Voltar ao início</a>
            </section>

        <% } %>

    </main>

    <script>
        const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('close-menu');
    const toggleBtn = document.getElementById("toggle-menu");

    function toggleMobileMenu() {
      menu.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.classList.toggle('no-scroll', menu.classList.contains('active'));
    }

    if (menuBtn) menuBtn.addEventListener('click', toggleMobileMenu);
    if (overlay) overlay.addEventListener('click', toggleMobileMenu);
    if (closeBtn) closeBtn.addEventListener('click', toggleMobileMenu);

    if (toggleBtn) {
      const toggleIcon = document.getElementById('toggle-icon');
      const isCollapsed = menu.classList.contains('collapsed');
      toggleBtn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
      if (isCollapsed) toggleIcon.style.transform = 'rotate(180deg)';

      toggleBtn.addEventListener("click", (e) => {
        e.preventDefault();
        menu.classList.toggle("collapsed");
        const isNowCollapsed = menu.classList.contains('collapsed');
        toggleBtn.setAttribute('aria-expanded', isNowCollapsed ? 'false' : 'true');
        toggleIcon.style.transform = isNowCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
      });
    }
    </script>

</body>

</html>
